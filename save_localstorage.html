<?php
session_start();
require_once 'models/UserModel.php';

// Kết nối Redis
$redis = new Redis();
$redis->connect('redis', 6379); 

$userModel = new UserModel();

// Xử lý POST login
if (!empty($_POST['submit'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];

    $user = $userModel->auth($username, $password);

    if ($user) {
        // Tạo token ngẫu nhiên
        $token = bin2hex(random_bytes(16));

        // Lưu user info vào Redis theo token
        $redis->set("login:$token", json_encode([
            'id' => $user[0]['id'],
            'name' => $user[0]['name']
        ]));
        $redis->expire("login:$token", 3600); // 1h

        // Trả token về client để lưu LocalStorage
        echo "<script>
            localStorage.setItem('token', '$token');
            window.location.href = 'list_users.php';
        </script>";
        exit;
    } else {
        echo "<script>alert('Login failed');</script>";
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
</head>
<body>
<div class="container">
    <h2>Login</h2>
    <form method="post" class="form-horizontal">
        <div class="form-group">
            <label class="control-label col-sm-2">Username:</label>
            <div class="col-sm-10">
                <input type="text" name="username" class="form-control" placeholder="Username">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-sm-2">Password:</label>
            <div class="col-sm-10">
                <input type="password" name="password" class="form-control" placeholder="Password">
            </div>
        </div>
        <div class="form-group">        
            <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" name="submit" class="btn btn-primary">Login</button>
            </div>
        </div>
    </form>
</div>
</body>
</html>
